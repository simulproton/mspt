

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mspt.simulator.simulatorMSPT &mdash; mspt  documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="mspt  documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../../index.html" class="fa fa-home"> mspt</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mspt.html">mspt package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../mspt.html#subpackages">Subpackages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../mspt.html#module-mspt">Module contents</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">mspt</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>mspt.simulator.simulatorMSPT</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <h1>Source code for mspt.simulator.simulatorMSPT</h1><div class="highlight"><pre>
<span class="c">########################################################################</span>
<span class="c">#</span>
<span class="c"># simulatorMSPT.py</span>
<span class="c"># Proton Therapy Simulator Project</span>
<span class="c"># Created by Paul Morel, LIGM, Universite Paris-Est Marne La Vallee</span>
<span class="c"># April 2012</span>
<span class="c"># </span>
<span class="c">#</span>
<span class="c">########################################################################</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span><span class="nn">os</span><span class="o">,</span><span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="kn">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">cProfile</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">..dicomReader.dicomManager</span> <span class="kn">import</span> <span class="n">DicomManager</span>
<span class="kn">from</span> <span class="nn">..patient.patient</span> <span class="kn">import</span> <span class="n">Patient</span>
<span class="kn">from</span> <span class="nn">..physics.stoppingPower</span> <span class="kn">import</span> <span class="n">StoppingPower</span> <span class="k">as</span> <span class="n">stpw</span>
<span class="kn">from</span> <span class="nn">..physics.ddCurvesManager</span> <span class="kn">import</span> <span class="n">DDCurves</span>
<span class="kn">from</span> <span class="nn">..motion.motionManager</span> <span class="kn">import</span> <span class="n">Motion</span>
<span class="kn">from</span> <span class="nn">..motion.motionMonitor</span> <span class="kn">import</span> <span class="n">MotionMonitor</span>
<span class="kn">from</span> <span class="nn">..dataViewer</span> <span class="kn">import</span> <span class="n">array2DViewer</span> <span class="k">as</span> <span class="n">viewer2D</span>
<span class="kn">from</span> <span class="nn">..dataViewer</span> <span class="kn">import</span> <span class="n">plotDataGraphs</span> <span class="k">as</span> <span class="n">pltData</span>
<span class="kn">from</span> <span class="nn">..dataViewer</span> <span class="kn">import</span> <span class="n">dvh</span>
<span class="kn">from</span> <span class="nn">..scanning.deliverySimulation_Static_Dynamic</span> <span class="kn">import</span> <span class="n">simulatorDelivery</span>
<span class="kn">from</span> <span class="nn">tools</span> <span class="kn">import</span> <span class="n">Tools</span> <span class="k">as</span> <span class="n">simTools</span>

<span class="kn">from</span>  <span class="nn">..email</span> <span class="kn">import</span> <span class="n">Email</span>
<span class="kn">from</span>  <span class="nn">..email.Email</span> <span class="kn">import</span> <span class="n">Email</span> <span class="k">as</span> <span class="n">emailManager</span>
<span class="kn">from</span> <span class="nn">..zip</span> <span class="kn">import</span> <span class="n">zipFiles</span>

<span class="kn">from</span> <span class="nn">globalVariables</span> <span class="kn">import</span> <span class="n">GlobalVariables</span>


<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;nt&#39;</span><span class="p">:</span> <span class="c">#windows</span>
    <span class="n">cpCmd</span> <span class="o">=</span> <span class="s">&#39;copy&#39;</span>
    <span class="n">scpCmd</span> <span class="o">=</span> <span class="s">&#39;copy&#39;</span>
    <span class="n">rmCmd</span> <span class="o">=</span> <span class="s">&#39;del&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">cpCmd</span> <span class="o">=</span> <span class="s">&#39;cp&#39;</span>
    <span class="n">scpCmd</span> <span class="o">=</span> <span class="s">&#39;scp&#39;</span>
    <span class="n">rmCmd</span> <span class="o">=</span> <span class="s">&#39;rm&#39;</span>


<div class="viewcode-block" id="MSPT"><a class="viewcode-back" href="../../../mspt.simulator.html#mspt.simulator.simulatorMSPT.MSPT">[docs]</a><span class="k">class</span> <span class="nc">MSPT</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;The class &quot;MSPT&quot;,  is the main class of the simulator. It controls the global simulation process.</span>
<span class="sd">    </span>
<span class="sd">    :param params: List of the input files of the simulator:</span>
<span class="sd">    </span>
<span class="sd">        * The path to a CT dicom directory in which is contained the CT dicom series.</span>
<span class="sd">        * The path to the RP dicom file (treatment plan)</span>
<span class="sd">        * The path to the RS dicom file (structures defined in the CT)</span>
<span class="sd">        * (optional) The path to the RD dicom file (expected dose distribution)</span>
<span class="sd">        * (optional) The path to the file configuring MSPT. If no file is provided MSPT will run a simulation on a static patient and \</span>
<span class="sd">        MSPT will be configured using default settings (see simulator.globalVariables). If provided, the configuration file is received by MSPT \</span>
<span class="sd">        but the configuration can be performed before. In such case &#39;globalVars&#39; should not be None. </span>
<span class="sd">        </span>
<span class="sd">    :param globalVars: Dictionary containing the configuration data of MSPT. If None: </span>
<span class="sd">    </span>
<span class="sd">        * If the configuration file is provided: MSPT will be configured using this file. The missing parameters will be set to default.</span>
<span class="sd">        * If the configuration file is not provided: SPT will be configured with default settings: static delivery and output data stored to local directory.</span>
<span class="sd">        </span>
<span class="sd">    .. note::</span>
<span class="sd">    </span>
<span class="sd">        The configuration file can either be &#39;.txt&#39; or &#39;.py&#39;. In this file do not precede variables with an indentation.\</span>
<span class="sd">        Enter 1 variable per line: myVariable = Value . All the following variables can be set in this file, but they are not mandatory since they all have\</span>
<span class="sd">        a default value:</span>
<span class="sd">        </span>
<span class="sd">            * variables common to static and dynamic deliveries:</span>
<span class="sd">                </span>
<span class="sd">                * **mainPath**: String defining the path where the simulation directory will be created. By default: &#39;../Data_Simulation/&#39;</span>
<span class="sd">                * **nameSimulation** : corresponds to the path where the simulation output data will be saved. Default: &#39;runSimulStatic/&#39;&#39; for a static\</span>
<span class="sd">                delivery, &#39;runSimulDynamic/&#39; for a dynamic simulation.</span>
<span class="sd">                * **nameProfilage** : name of the profilage file created using the package &#39;cProfile&#39;. This profilage data can be after studied using the cProfile package in python or \</span>
<span class="sd">                with the profilage viewer `runsnake &lt;http://www.vrplumber.com/programming/runsnakerun/&gt;`_ . Default: &#39;profilagerunSimulStatic.profile&#39; for a static delivery, \</span>
<span class="sd">                &#39;profilagerunSimulDynamic.profile&#39; for a dynamic delivery.</span>
<span class="sd">                * **removeProfilageData** : True (default) or False depending if the user wants to delete the profilage data when the simulation ends. </span>
<span class="sd">                * **stdOutErrToFile** : True or False (default). If True the standard output and error are redirected to a text file \</span>
<span class="sd">                in the simulation directory.</span>
<span class="sd">                * **zipSavedData** : True (default) or False. If True, the simulation directory containing the output data is zipped in &#39;maintPath&#39;. \</span>
<span class="sd">                Note: if the user access directly the class MSPT (not using the &#39;__main__&#39; function) the zip option is not available. </span>
<span class="sd">                * **copyZip** : True (default) or False. If True the zip file is copied to the &#39;pathToCopyZip&#39; directory.</span>
<span class="sd">                * **pathToCopyZip** : String defining where to copy the zip file. Default: &#39;../Data_Zip/&#39;</span>
<span class="sd">                * **typeFloat** : The type of numpy float to be used: &#39;float32&#39; or &#39;float64&#39;. Default : &#39;float64&#39;.</span>
<span class="sd">                * **emailUser** : If the user wants to send an email saying that the simulation ended with the DVH(s) and the the data printed in the \</span>
<span class="sd">                standard output (or if the simulation crashed for any reason), he can fill this variable with his e-mail address en fill the next fields. \</span>
<span class="sd">                Note: if the user access directly the class MSPT (not using the &#39;__main__&#39; function) the email option is not available.\</span>
<span class="sd">                Default: None</span>
<span class="sd">                * **emailPwd** : e-mail password. Default: None</span>
<span class="sd">                * **emailSMTP** : e-mail smpt server address. Default: None</span>
<span class="sd">                * **emailSMTPPort** : smtp server port. Default: None</span>
<span class="sd">                * **emailRecipient** : e-mail address of the e-mail&#39;s recipient. Default: None</span>
<span class="sd">                * **staticDelivery**: True (default) or False. If True the delivery is performed for a static patient. Otherwise for a moving (dynamic)\</span>
<span class="sd">                patient.</span>
<span class="sd">                * **ddCurves**: String defining the set of dept-dose curves to use. By default &#39;RayStation&#39;. It is also possible to use &#39;MCNPX&#39; or &#39;Eclipse&#39;, \</span>
<span class="sd">                but these two datasets have not been tested. The user can also add its own depth dose curves. See physics.ddCurvesManager.DDCurve for more information.</span>
<span class="sd">                * **displayScanPathUpdates** : True or False (default). If True it displays the evolution of 2D array representing the scanning path\</span>
<span class="sd">                in an energy layer. See dicomReader.scanningPath for more details.</span>
<span class="sd">                * **saveCTImage** : True :save the CT dicom image as tiff image files, False otherwise. Default: True</span>
<span class="sd">                * **listSaveCTImageAlong** (if &#39;saveCTImage&#39; is True): list of the axis along which the user wants to save the CT images of the patient. Possible values are\</span>
<span class="sd">                &#39;x&#39; (i.e. the images are stored along the column axis of the dicom image), &#39;y&#39; (i.e. the images are stored along the rows axis of the dicom image), \</span>
<span class="sd">                &#39;z&#39; (i.e. the images are stored along the frame axis of the dicom image - default). Examlpes: listSaveCTImageAlong = [] (in this case default value is used) , or listSaveCompDoseAlong = [&#39;x&#39;] or listSaveCompDoseAlong = [&#39;x&#39;,&#39;z&#39;] ... \</span>
<span class="sd">                Default: [&#39;z&#39;].</span>
<span class="sd">                * **skipSaveDensityImage** : False to save the 3D density array as a set of png images. True otherwise. Default: True</span>
<span class="sd">                * **listSaveDensImAlong** (if &#39;skipSaveDensityImage&#39; is False): list of the axis along which the user wants to save the density \</span>
<span class="sd">                images of the patient. Default: [&#39;z&#39;].</span>
<span class="sd">                * **saveDensCPKL** (if &#39;skipSaveDensityImage&#39; is False): True if the user wants to store the density 3D array in a cPickle structure (this allows to have access to the \</span>
<span class="sd">                3D numpy array outdise the simulation). False otherwise. Moreover, if False and the patient is moving\</span>
<span class="sd">                it will stored the 3D density array every time the array is updated. Default: False.</span>
<span class="sd">                * **skipSaveStpPwrImage** : False to save the 3D relative stopping power array as a set of png images. True otherwise. Default: True</span>
<span class="sd">                * **listSaveStPwrImAlong** (if &#39;skipSaveStpPwrImage&#39; is False): list of the axis along which the user wants to save the rel. stop. power \</span>
<span class="sd">                images of the patient. Default: [&#39;z&#39;]. </span>
<span class="sd">                * **saveStpPwrCPKL** (if &#39;skipSaveStpPwrImage&#39; is False):Similar to &#39;saveDensCPKL&#39; to save the 3D array of the relative stopping power. However, if the patient is moving it only stores it once.</span>
<span class="sd">                * **skipSaveDeff** : False to save the 3D radiological depth array as a set of png images. True otherwise. Default: True</span>
<span class="sd">                * **listSaveDeffAlong** : Similar to &#39;listSaveDensImAlong&#39;, to save the images of the 3D radiological depth matrix.</span>
<span class="sd">                * **saveDeffCPKL** : Similar to &#39;saveDensCPKL&#39; to save the 3D radiological depth matrix. If the patient is moving it stores the array at every update.</span>
<span class="sd">                * **skipSaveBeamlets** : False to save an image of the dose distribution of each beamlet simulated, True otherwise. Default : True</span>
<span class="sd">                * **saveBeamletsCPKL** (if skipSaveBeamlets is False): True to save the dose distribution of each beamlet (a 3D numpy array) in a cPickle structure.</span>
<span class="sd">                * **listSaveCompDoseAlong** : list of the axis along which the user wants to save the computed dose \</span>
<span class="sd">                images (png) of the patient. Default: [&#39;z&#39;]. Note: This variable is also used to store the density and the pencil beam dose distribution in a \</span>
<span class="sd">                dynamic delivery if the variable &#39;storeInterDoseDens&#39; (defined below) is True.</span>
<span class="sd">                * **saveCompDoseAsDcm** : True to save the computed dose distribution into a RD dicom file. False otherwise. Default : True</span>
<span class="sd">                * **nameCompDose** : Name of the output RD dicom file for the computed dose distribution. Default: &#39;RD_CompDose_MSPT.dcm&#39; </span>
<span class="sd">                * **saveRefDoseAsDcm** : True to save the expect dose distribution into a RD dicom file  (False otherwise). This is useful if the input dose grid\</span>
<span class="sd">                must be resampled to the voxel spacing of the input CT dicom series. Moreover, this can only be done if the user provided an inpu RD dicom file. Default : True</span>
<span class="sd">                * **nameRefDose** : Name of the output RD dicom file for the expected dose distribution. Default: &#39;RD_RefDose.dcm&#39;</span>
<span class="sd">                * **saveRefDose** : True :save the expected dose distribution image as png image files, False otherwise. Default: True</span>
<span class="sd">                * **listSaveRefDoseAlong** (if saveRefDose True) : list of the axis along which the user wants to save the expected dose distribution images.</span>
<span class="sd">                * **dvhRelativeVolume** : True to convert the volumes into relative volumes in the dose volume histograms. False otherwise.  Default: True.</span>
<span class="sd">                * **displaySliceOrderingInfo** : True to display the order and positions (in mm) of the CT dicom slices. False otherwise. Default: False.</span>
<span class="sd">                * **exportSliceOrderingInfo** : True to export the order and positions (in mm) of the CT dicom slices into a cszv file. False otherwise. Default: False.</span>
<span class="sd">                * **storeMasksAsCPKL** : True to store binary matrices representing the patient structures (VOIs: Volumes of Interest) into cPickle structures.</span>
<span class="sd">                * **protPerMU** : Number of protons per Monitor Units (MU). Default: 1e9 prot.MU-1.</span>
<span class="sd">            </span>
<span class="sd">            </span>
<span class="sd">            * variables for dynamic deliveries:</span>
<span class="sd">                </span>
<span class="sd">                * **unitTimeForDelivery** : time unit to simulate the dynamic delivery (moving patient) expressed in seconds. It corresponds to the time resolution. Default: 1e-3.</span>
<span class="sd">                * **typeMotion** : the type of motion applied to the patient: &#39;motionNoisyCos&#39;,&#39;motionCos&#39;,&#39;motionBreathHiccup&#39; or &#39;motionBreathCough&#39;. See package motion for more information. \</span>
<span class="sd">                Default: &#39;motionCos&#39;.</span>
<span class="sd">                * **arrayPeriod** : List of the motion period (in seconds) along x,y, and z axis in the IEC fixed coordinate system. \</span>
<span class="sd">                Default : [4.0,  3.5,   0.0].Note: X_IEC fixed= X_Dicom, Y_IEC fixed = Z_Dicom, Z_IEC fixed = -Y_Dicom.               </span>
<span class="sd">                * **arrayAmpl** : List of the motion amplitude (in cm) along x,y, and z axis in the IEC fixed coordinate system. \</span>
<span class="sd">                Default : [1.0,  1.0,  0.0]</span>
<span class="sd">                * **arrayPhase** : List of the motion initial phase (in rad.) along x,y, and z axis in the IEC fixed coordinate system. \</span>
<span class="sd">                Default : [0,  0,  0]</span>
<span class="sd">                * **arrayStDevPeriod** (if &#39;typeMotion&#39; is &#39;motionNoisyCos&#39;, &#39;motionBreathHiccup&#39; or &#39;motionBreathCough&#39;): List of standard deviations (in seconds) \</span>
<span class="sd">                for the gaussian distribution used to simulate changes (noise) in period of the motion along x,y, and z axis in the IEC fixed coordinate system. \</span>
<span class="sd">                Default : [0,  0,  0]</span>
<span class="sd">                * **arrayStDevAmpl** (if &#39;typeMotion&#39; is &#39;motionNoisyCos&#39;, &#39;motionBreathHiccup&#39; or &#39;motionBreathCough&#39;): List of standard deviations (in cm)\</span>
<span class="sd">                for the gaussian distribution used to simulate changes (noise) in amplitude of the motion along x,y, and z axis in the IEC fixed coordinate system. \</span>
<span class="sd">                Default : [0,  0,  0]</span>
<span class="sd">                * **ctPadding** : True if the user wants to add margins of a specified density (see &#39;paddedCTValue&#39; ) around\</span>
<span class="sd">                the current CT image. This is useful, when the moving patient can be outside of the bounding box formed by the borders of the CT image.  </span>
<span class="sd">                * **padValueFRC** (if &#39;ctPadding&#39; is True) : Numpy array of 3 integer values : [ number of added frames : nbF, number of added rows : nbR, \</span>
<span class="sd">                number of added columns : nbC]. For exemple : [ 0,0,10] will add 10 columns to the right of the CT image and 10 columns to the left of the CT image.\</span>
<span class="sd">                Default: [10,10,10].</span>
<span class="sd">                * **paddedCTValue** (if &#39;ctPadding&#39; is True): The value in CT number (Hounsfield Units) to use to pad the CT image. For example: air = -1000 HU, water = 0 HU.</span>
<span class="sd">                * **storeInterDoseDens** : True to store the density image of the moving patient and the dose distribution of the beam when the \</span>
<span class="sd">                patient is moving while being irradiated by a pencil beam. False otherwise. Default: False. Note: It uses the variable \</span>
<span class="sd">                &#39;listSaveCompDoseAlong&#39; to save the images.</span>
<span class="sd">                * **motionDuringBeam** :  True to allow the patient to move while the beam is irradiating, False otherwise. Default : True.</span>
<span class="sd">                * **compensationDynamic** : True to allow motion compensation, False otherwise. Default : False.</span>
<span class="sd">                * **measurementStdev** (if compensationDynamic is True):  List of the standard deviation of the motion monitoring accuracy (in cm.) \</span>
<span class="sd">                along x,y, and z axis in the IEC fixed coordinate system. Default : [0.1,  0.1,  0]</span>
<span class="sd">                * **measurementAvg** (if compensationDynamic is True):List of the average of the motion monitoring accuracy (in cm.) along x,y, and z axis in the IEC fixed\</span>
<span class="sd">                coordinate system. Default : [0.1,  0.1,  0].</span>
<span class="sd">                * **timeMeasureDisplacement** (if compensationDynamic is True): Time (in seconds) needed to measure the patient displacement with the monitoring system. Default: 1e-3.</span>
<span class="sd">                * **findStartPos** (if compensationDynamic is True): </span>
<span class="sd">                * **nameNewRPFile** (if compensationDynamic is True):</span>
<span class="sd">                * **addMargins** (if compensationDynamic is True):</span>
<span class="sd">                * **marginsParam** (if compensationDynamic is True):</span>
<span class="sd">                * **updateMargins** (if compensationDynamic is True):</span>
<span class="sd">                * **unlimitedRescanning** : True to allow an unlimited number (the maximum, however, is set to 32767 repaintings to avoid infinite loops) of repainting per energy slice.\</span>
<span class="sd">                False otherwise.</span>
<span class="sd">                * **repaintingFactor** (if unlimitedRescanning is False): Repainting factor. Default: 1. </span>
<span class="sd">                * **sliceRepaint** : Type of slice repainting method. Types :&#39;IsolayerRepaint&#39;,&#39;ScaledRepaint&#39; or &#39;FullWeightRepainting&#39;.\</span>
<span class="sd">                Note: &#39;FullWeightRepainting&#39;: we deliver the full weight at once instead of a maximum weight or a scaled weight.</span>
<span class="sd">                * **volumeRepaint** : Type volume repainting method. Types : &#39;Volumetric&#39; and &#39;NonVolumetric&#39;. Default : &#39;NonVolumetric&#39;.                </span>
<span class="sd">                * **evaluateDiffStatDyna** : True to show and store statistics about the differences between dose distributions  at a beam position when \</span>
<span class="sd">                the patient is moving and when he is static. Default: False.</span>
<span class="sd">                * **synchrotron** : True to make MSPT behave like a synchrotron (i.e., pulsatile proton delivery, time needed to refill the synchrotron and the \</span>
<span class="sd">                time to change the energy is longer than for cyclotrons). Otherwise (False) it behaves like a cyclotron (i.e., continuous proton delivery\</span>
<span class="sd">                 the time to change the energy is shorter. Default: True</span>
<span class="sd">                * **spillLength** ( if synchrotron is True): length in seconds of a proton spill. Default: 5.</span>
<span class="sd">                * **timeEnergyChange** : Time (in seconds) to change the energy. Default: 2.1 ( if synchrotron is True) , 50e-3 ( if synchrotron is False).</span>
<span class="sd">                * **spotSettlingTime** : Time (in seconds) needed to stabilize the beam position. Default : 5e-3.</span>
<span class="sd">                * **lateralScanningSpeed** : Lateral scanning speed of the beam (in cm/s). Default : 1000.</span>
<span class="sd">                * **verticalScanningSpeed** : Vertical scanning speed of the beam (in cm/s). Default : 1000.</span>
<span class="sd">                * **speedGantryRotation** : Gantry rotational speed in degrees / min. Default: 360.</span>
<span class="sd">                * **beamIntensity** : Beam intensity (or extraction rate), i.e. number of protons per second being delivered. Default: 6.8e10</span>
<span class="sd">       </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span> <span class="p">,</span> <span class="n">globalVars</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">      </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">paramsDicom</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">5</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">strErr</span> <span class="o">=</span> <span class="s">&quot;Error number of arguments for the simulator..! 3,4 or 5 are expected, </span><span class="si">%i</span><span class="s"> are given.&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">strErr</span><span class="p">);</span>
        <span class="k">else</span><span class="p">:</span>            

            <span class="k">print</span> <span class="s">&#39;Starting MSPT....&#39;</span>
            <span class="n">configFile</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.py&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.txt&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">globalVars</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">configFile</span> <span class="o">=</span> <span class="n">item</span>
                        <span class="n">globalVars</span> <span class="o">=</span> <span class="n">GlobalVariables</span><span class="p">(</span><span class="n">configFile</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">item</span> <span class="o">==</span> <span class="s">&#39;--motion&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">globalVars</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;tmp_ConfigData.txt&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">myFile</span><span class="p">:</span>
                            <span class="n">myFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;staticDelivery = False </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                        <span class="n">globalVar</span> <span class="o">=</span> <span class="n">GlobalVariables</span><span class="p">(</span><span class="s">&#39;tmp_ConfigData.txt&#39;</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> tmp_ConfigData.txt&quot;</span><span class="o">%</span><span class="n">rmCmd</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">paramsDicom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">configFile</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">globalVars</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">globalVars</span> <span class="o">=</span> <span class="n">GlobalVariables</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span> <span class="o">=</span> <span class="n">globalVars</span> 

            <span class="k">print</span> <span class="s">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Beam Scanning Proton Machine Settings &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&quot;</span>
            <span class="k">print</span> <span class="s">&quot;# of protons/MU: </span><span class="si">%0.2e</span><span class="s">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">protPerMU</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">synchrotron</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;Machine Type: Synchrotron&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;Machine Type: Cyclotron&quot;</span>
                <span class="k">print</span> <span class="s">&quot;Extraction rate: </span><span class="si">%0.2e</span><span class="s"> protons/s&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">beamIntensity</span>
                <span class="k">print</span> <span class="s">&quot;Time to change the energy: </span><span class="si">%0.2f</span><span class="s"> s&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">timeEnergyChange</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">synchrotron</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;Spill length: </span><span class="si">%0.2f</span><span class="s"> s&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">spillDuration</span>
                <span class="k">print</span> <span class="s">&quot;Lateral scanning speed: </span><span class="si">%0.2f</span><span class="s"> m/s&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">lateralScanningSpeed</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&quot;Vertical scanning speed: </span><span class="si">%0.2f</span><span class="s"> m/s&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">verticalScanningSpeed</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&quot;Gantry rotational speed: </span><span class="si">%0.2f</span><span class="s"> degrees/min&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">speedGantryRotation</span>
            <span class="k">print</span> <span class="s">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; End Machine Settings  &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&quot;</span>
            
            
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; MSPT Settings for Motion &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&quot;</span>
                <span class="k">print</span> <span class="s">&quot;Unit time for delivery: </span><span class="si">%e</span><span class="s"> s&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">unitTimeForDelivery</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">compensationDynamic</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;Time for motion measurement: </span><span class="si">%e</span><span class="s"> s&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">timeMeasureDisplacement</span>
                <span class="k">print</span> <span class="s">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; End MSPT Settings for Motion  &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&quot;</span>
            
            <span class="n">pathToSave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">mainPath</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">nameSimulation</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">)</span>

            <span class="k">print</span> <span class="s">&quot;Starting simulation </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">nameSimulation</span>
            <span class="n">dcmManager</span> <span class="o">=</span> <span class="n">DicomManager</span><span class="p">(</span><span class="n">paramsDicom</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
            
            <span class="c"># Create patient from dicom data</span>
            <span class="n">dicomDataForPatient</span> <span class="o">=</span> <span class="n">dcmManager</span><span class="o">.</span><span class="n">getDicomReadersForPatient</span><span class="p">()</span>
            
            <span class="c">#Initialize stopping power ratios data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dataRefStopPwr</span> <span class="o">=</span> <span class="n">stpw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="p">)</span>
            
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span> <span class="o">=</span> <span class="n">Patient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataRefStopPwr</span><span class="p">,</span><span class="n">dicomDataForPatient</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="p">)</span>
            
            <span class="c"># get Scanning Path , number of fractions,:</span>
            <span class="n">dicomDataPlan</span> <span class="o">=</span> <span class="n">dcmManager</span><span class="o">.</span><span class="n">getDicomReaderForScanningPath</span><span class="p">()</span>
            <span class="n">numberOfFractionsPlanned</span> <span class="o">=</span> <span class="n">dicomDataPlan</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;NumberOfFractionsPlanned&#39;</span><span class="p">)</span>
            <span class="n">spotPositions</span> <span class="o">=</span> <span class="n">dicomDataPlan</span><span class="o">.</span><span class="n">getScanningPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">settingsScanning</span><span class="p">)</span>
            <span class="n">dicomDataPlanPath</span> <span class="o">=</span> <span class="n">dicomDataPlan</span><span class="o">.</span><span class="n">rtPlanPath</span>
            <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Treatment plan loaded !&quot;</span>
            
            <span class="c">#Initialize depth dose curves</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ddCurvesData</span> <span class="o">=</span> <span class="n">DDCurves</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="p">)</span>
            
            <span class="c">#Simulate treatment</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span> <span class="c">#Static delivery</span>
                <span class="n">simulator</span> <span class="o">=</span> <span class="n">simulatorDelivery</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddCurvesData</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="p">)</span>
                <span class="n">simulator</span><span class="o">.</span><span class="n">simulateDelivery</span><span class="p">(</span><span class="n">spotPositions</span><span class="p">)</span>
                
                
            <span class="k">else</span><span class="p">:</span> <span class="c">#Dynamic delivery</span>
                <span class="n">motion</span> <span class="o">=</span> <span class="n">Motion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">motionInfo</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">compensationDynamic</span><span class="p">:</span>
                    <span class="n">monitoringSystm</span> <span class="o">=</span> <span class="n">MotionMonitor</span><span class="p">(</span><span class="n">motion</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">measurementStdev</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">measurementAvg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">monitoringSystm</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">simulator</span> <span class="o">=</span> <span class="n">simulatorDelivery</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddCurvesData</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="p">,</span> <span class="n">motion</span> <span class="o">=</span> <span class="n">motion</span> <span class="p">,</span> <span class="n">monitor</span> <span class="o">=</span><span class="n">monitoringSystm</span> <span class="p">)</span>
                <span class="n">compensatedPlan</span> <span class="o">=</span> <span class="n">simulator</span><span class="o">.</span><span class="n">simulateDelivery</span><span class="p">(</span><span class="n">spotPositions</span><span class="p">)</span>
                <span class="c">#Note: compensatedPlan is None if there is no compensation</span>
                
            
            <span class="c">#Get computed dose.</span>
            <span class="n">simulatedDose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getUnpaddedPatientDataForAttr</span><span class="p">(</span><span class="s">&#39;receivedDose&#39;</span><span class="p">)</span>
            <span class="c">#Store results - total Dose</span>
            

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">saveCTImage</span><span class="p">:</span>
                <span class="n">ctImage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getUnpaddedPatientDataForAttr</span><span class="p">(</span><span class="s">&#39;pixelValues&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">listSaveCTImageAlong</span><span class="p">:</span>
                    <span class="n">viewer2D</span><span class="o">.</span><span class="n">storeMatrixAsImage</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">,</span><span class="n">ctImage</span><span class="p">,</span><span class="s">&quot;DcmImage&quot;</span><span class="p">,</span><span class="n">alongAxis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">,</span><span class="n">bw</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
                <span class="n">spacingList</span> <span class="o">=</span> <span class="p">[[</span><span class="s">&#39;Cols&#39;</span><span class="p">,</span><span class="s">&#39;Rows&#39;</span><span class="p">,</span><span class="s">&#39;Frames&#39;</span><span class="p">],[</span><span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getSpacingInfo</span><span class="p">(</span><span class="s">&#39;x_spacing&#39;</span><span class="p">)</span><span class="o">/</span><span class="mf">10.0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getSpacingInfo</span><span class="p">(</span><span class="s">&#39;y_spacing&#39;</span><span class="p">)</span><span class="o">/</span><span class="mf">10.0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getSpacingInfo</span><span class="p">(</span><span class="s">&#39;z_spacing&#39;</span><span class="p">)</span><span class="o">/</span><span class="mf">10.0</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save2DListToCSV</span><span class="p">(</span><span class="n">spacingList</span><span class="p">,</span><span class="s">&quot;SpacingData_in_cm&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">skipSaveDensityImage</span><span class="p">:</span>
                <span class="n">densImage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getUnpaddedPatientDataForAttr</span><span class="p">(</span><span class="s">&#39;density&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">listSaveDensImAlong</span><span class="p">:</span>
                    <span class="n">viewer2D</span><span class="o">.</span><span class="n">storeMatrixAsImage</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">,</span><span class="n">densImage</span><span class="p">,</span><span class="s">&quot;DensityImage&quot;</span><span class="p">,</span><span class="n">alongAxis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">)</span>


        
            <span class="c"># Get the planned dose matrix</span>
            <span class="n">prescribedDoseLoaded</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">doseDistrOfRef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getUnpaddedPatientDataForAttr</span><span class="p">(</span><span class="s">&#39;prescribedDose&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">doseDistrOfRef</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                 <span class="n">prescribedDoseLoaded</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">prescribedDoseLoaded</span> <span class="ow">and</span> <span class="n">numberOfFractionsPlanned</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">doseDistrOfRef</span> <span class="o">=</span> <span class="n">doseDistrOfRef</span> <span class="o">/</span> <span class="n">numberOfFractionsPlanned</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">skipSaveStpPwrImage</span><span class="p">:</span>
                <span class="n">stpPwrRatioImage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getUnpaddedPatientDataForAttr</span><span class="p">(</span><span class="s">&#39;stpPwrRatio&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">listSaveStPwrImAlong</span><span class="p">:</span>
                    <span class="n">viewer2D</span><span class="o">.</span><span class="n">storeMatrixAsImage</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">,</span><span class="n">stpPwrRatioImage</span><span class="p">,</span><span class="s">&quot;stpPwrImage&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">prescribedDoseLoaded</span><span class="p">:</span><span class="c">#Clip smallest dose values in computed dose to 0.</span>
                <span class="n">tool</span> <span class="o">=</span> <span class="n">simTools</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="p">)</span>
                <span class="n">minRef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span> <span class="n">doseDistrOfRef</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">doseDistrOfRef</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span>
                <span class="n">indSmallVlaues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">simulatedDose</span> <span class="o">&lt;</span> <span class="n">minRef</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">simulatedDose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">simulatedDose</span><span class="p">[</span><span class="n">indSmallVlaues</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">frame</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">doseDistrOfRef</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">save2DSliceToCSV</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="s">&quot;RefDose_Frame&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
            
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">saveRefDoseAsDcm</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">saveDoseDistrAsRDDcmFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getUnpaddedPatientDataForAttr</span><span class="p">(</span><span class="s">&#39;prescribedDose&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">nameRefDose</span><span class="p">)</span>
            
            
            <span class="c">#Save computed dose</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">saveCompDoseAsDcm</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">saveDoseDistrAsRDDcmFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getUnpaddedPatientDataForAttr</span><span class="p">(</span><span class="s">&#39;receivedDose&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">nameCompDose</span><span class="p">)</span>

            
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">frame</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">simulatedDose</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save2DSliceToCSV</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="s">&quot;simulatedDose_Frame&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="n">prescribedDoseLoaded</span><span class="p">:</span>
                <span class="c">#Find min/max values to use to display simulated dose and ref dose in same color scale.</span>
                <span class="nb">min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">simulatedDose</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">doseDistrOfRef</span><span class="p">)]</span> <span class="p">)</span>
                <span class="nb">max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">simulatedDose</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">doseDistrOfRef</span><span class="p">)]</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">simulatedDose</span><span class="p">)</span>
                <span class="nb">max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">simulatedDose</span><span class="p">)</span>
                
            
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">listSaveCompDoseAlong</span><span class="p">:</span>
                <span class="n">viewer2D</span><span class="o">.</span><span class="n">storeMatrixAsImage</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">,</span><span class="n">simulatedDose</span><span class="p">,</span><span class="s">&quot;SimulatedDose&quot;</span><span class="p">,</span><span class="n">alongAxis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">,</span><span class="n">minmax</span><span class="o">=</span><span class="p">[</span><span class="nb">min</span><span class="p">,</span><span class="nb">max</span><span class="p">],</span><span class="n">bw</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">saveRefDose</span> <span class="ow">and</span> <span class="n">prescribedDoseLoaded</span><span class="p">:</span>
                <span class="c">#Store prescribed dose  </span>
                <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">listSaveRefDoseAlong</span><span class="p">:</span>
                    <span class="n">viewer2D</span><span class="o">.</span><span class="n">storeMatrixAsImage</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">,</span><span class="n">doseDistrOfRef</span><span class="p">,</span><span class="s">&quot;RefDose&quot;</span><span class="p">,</span><span class="n">alongAxis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">,</span><span class="n">minmax</span><span class="o">=</span><span class="p">[</span><span class="nb">min</span><span class="p">,</span><span class="nb">max</span><span class="p">],</span><span class="n">bw</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>

                
            <span class="k">if</span> <span class="n">prescribedDoseLoaded</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">computeEnergyReceivedByStructures</span><span class="p">(</span><span class="n">doseDistrOfRef</span><span class="p">,</span> <span class="s">&quot;Reference_DoseDistribution&quot;</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">computeEnergyReceivedByStructures</span><span class="p">(</span><span class="n">simulatedDose</span><span class="p">,</span> <span class="s">&quot;Simulated_DoseDistribution&quot;</span><span class="p">)</span> 
            
            <span class="k">if</span> <span class="n">prescribedDoseLoaded</span><span class="p">:</span>
                <span class="c">#Comparision planned dose and computed dose</span>
                <span class="k">print</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">##################################&quot;</span>
                <span class="k">print</span><span class="s">&quot;Evaluating Differences :  doseDistrOfRef  /  simulatedDose&quot;</span>
                <span class="n">tool</span><span class="o">.</span><span class="n">evaluateDifference</span><span class="p">(</span><span class="n">doseDistrOfRef</span><span class="p">,</span><span class="n">simulatedDose</span><span class="p">)</span>
                <span class="k">print</span><span class="s">&quot;##################################</span><span class="se">\n</span><span class="s">&quot;</span>
            
            
                <span class="c">#Show Hot and cold spots</span>
                <span class="n">tool</span><span class="o">.</span><span class="n">showHotColdSpots</span><span class="p">(</span><span class="n">doseDistrOfRef</span><span class="p">,</span><span class="n">simulatedDose</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s">&quot;Hot and Cold Spots&quot;</span> <span class="p">,</span> <span class="n">pathToSaveImg</span> <span class="o">=</span> <span class="n">pathToSave</span> <span class="o">+</span> <span class="s">&#39;HotColdSpotsBeamlets/&#39;</span><span class="o">+</span><span class="s">&#39;HotAndColdSpots_Final&#39;</span><span class="p">)</span>
            
                <span class="n">diffDose</span> <span class="o">=</span> <span class="n">tool</span><span class="o">.</span><span class="n">getMatrixHotAndColdSpot</span><span class="p">(</span><span class="n">doseDistrOfRef</span><span class="p">,</span><span class="n">simulatedDose</span><span class="p">)</span>
                <span class="c">#Save Cold Spots</span>
                <span class="n">matColdSpots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">diffDose</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">indCold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">diffDose</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indCold</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">maxCold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">diffDose</span><span class="p">[</span><span class="n">indCold</span><span class="p">])</span>
                    <span class="n">matColdSpots</span><span class="p">[</span><span class="n">indCold</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">diffDose</span><span class="p">[</span><span class="n">indCold</span><span class="p">]</span><span class="o">/</span> <span class="n">maxCold</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">listSaveCompDoseAlong</span><span class="p">:</span>    
                        <span class="n">viewer2D</span><span class="o">.</span><span class="n">storeMatrixAsImage</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">,</span><span class="n">matColdSpots</span><span class="p">,</span><span class="s">&quot;ColdSpots-FinalVolume&quot;</span><span class="p">,</span><span class="n">alongAxis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;No differences found between expected dose and computed dose, therefore cold spot will not be plotted&quot;</span> 
                <span class="c">#Save Hot Spots</span>
                <span class="n">matHotSpots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">diffDose</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">indHot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">diffDose</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indHot</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">maxHot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">diffDose</span><span class="p">[</span><span class="n">indHot</span><span class="p">])</span>
                    <span class="n">matHotSpots</span><span class="p">[</span><span class="n">indHot</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">diffDose</span><span class="p">[</span><span class="n">indHot</span><span class="p">]</span><span class="o">/</span> <span class="n">maxHot</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">listSaveCompDoseAlong</span><span class="p">:</span>    
                        <span class="n">viewer2D</span><span class="o">.</span><span class="n">storeMatrixAsImage</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">,</span><span class="n">matHotSpots</span><span class="p">,</span><span class="s">&quot;HotSpots-FinalVolume&quot;</span><span class="p">,</span><span class="n">alongAxis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;No differences found between expected dose and computed dose, therefore hot spots will not be plotted&quot;</span> 
                        
                        
                        
                <span class="n">dataHotColdSpots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">hotAndColdSpotsPerStrcuture</span><span class="p">(</span><span class="n">doseDistrOfRef</span><span class="p">,</span><span class="n">simulatedDose</span><span class="p">,</span> <span class="n">unpadded</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
                
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pathToSave</span> <span class="o">+</span> <span class="s">&#39;EvalHotColdSpots.txt&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">myFile</span><span class="p">:</span>
                    <span class="n">myFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Evaluation Hot and Cold spots :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                    <span class="n">myFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Note: Hot (resp. cold) spots are considered as such, if the absolute difference is greater than 5</span><span class="si">% o</span><span class="s">f the maximum dose in the expected dose distribution.</span><span class="se">\n\n\n</span><span class="s">&quot;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">dataHotColdSpots</span><span class="p">:</span>
                        <span class="n">myFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> :</span><span class="se">\n\t</span><span class="s">#of voxels: </span><span class="si">%i</span><span class="s"> , </span><span class="se">\n\t</span><span class="s">#of hot spot:</span><span class="si">%i</span><span class="s"> ( </span><span class="si">%0.3f</span><span class="s"> </span><span class="si">%%</span><span class="s">) , </span><span class="se">\n\t</span><span class="s">#of cold spots:</span><span class="si">%i</span><span class="s"> (</span><span class="si">%0.3f</span><span class="s"> </span><span class="si">%%</span><span class="s">), </span><span class="se">\n\t</span><span class="s">#of correct spots:</span><span class="si">%i</span><span class="s"> (</span><span class="si">%0.3f</span><span class="s"> </span><span class="si">%%</span><span class="s">)</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span><span class="n">dataHotColdSpots</span><span class="p">[</span><span class="n">roi</span><span class="p">][</span><span class="s">&#39;nbVoxels&#39;</span><span class="p">],</span>\
                        <span class="n">dataHotColdSpots</span><span class="p">[</span><span class="n">roi</span><span class="p">][</span><span class="s">&#39;nbHotSpots&#39;</span><span class="p">],</span>\
                        <span class="n">dataHotColdSpots</span><span class="p">[</span><span class="n">roi</span><span class="p">][</span><span class="s">&#39;percHotSpots&#39;</span><span class="p">],</span>\
                        <span class="n">dataHotColdSpots</span><span class="p">[</span><span class="n">roi</span><span class="p">][</span><span class="s">&#39;nbColdSpots&#39;</span><span class="p">],</span>\
                        <span class="n">dataHotColdSpots</span><span class="p">[</span><span class="n">roi</span><span class="p">][</span><span class="s">&#39;percColdSpots&#39;</span><span class="p">],</span>\
                        <span class="n">dataHotColdSpots</span><span class="p">[</span><span class="n">roi</span><span class="p">][</span><span class="s">&#39;nbCorrectSpots&#39;</span><span class="p">],</span>\
                        <span class="n">dataHotColdSpots</span><span class="p">[</span><span class="n">roi</span><span class="p">][</span><span class="s">&#39;percCorrectSpots&#39;</span><span class="p">]))</span>
                
                
                
                
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">displaySliceOrderingInfo</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">displaySliceOrderingInfo</span><span class="p">()</span>
                
                
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">exportSliceOrderingInfo</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">exportSliceOrderingInfo</span><span class="p">()</span>
            
            
            <span class="n">listVOIs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getUnpaddedPatientDataForAttr</span><span class="p">(</span><span class="s">&#39;maskVOIs&#39;</span><span class="p">)</span>
            
            <span class="c"># Build DVH for simulated dose</span>
            <span class="n">listDv</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span><span class="mi">99</span><span class="p">,</span><span class="mi">98</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">95</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mf">66.66</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mf">33.33</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">listVd</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">nameDVH</span> <span class="o">=</span> <span class="s">&#39;SimulatedDose&#39;</span>
            <span class="n">dvh</span><span class="o">.</span><span class="n">processDVHForDoseDistribution</span><span class="p">(</span><span class="n">simulatedDose</span><span class="p">,</span> <span class="n">listVOIs</span> <span class="p">,</span> <span class="n">listDv</span><span class="p">,</span> <span class="n">listVd</span><span class="p">,</span> <span class="n">nameDVH</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="p">)</span>
            <span class="k">if</span>  <span class="n">prescribedDoseLoaded</span><span class="p">:</span>
                <span class="n">nameDVH</span> <span class="o">=</span> <span class="s">&#39;ReferenceDose&#39;</span>
                <span class="n">dvh</span><span class="o">.</span><span class="n">processDVHForDoseDistribution</span><span class="p">(</span><span class="n">doseDistrOfRef</span><span class="p">,</span> <span class="n">listVOIs</span> <span class="p">,</span> <span class="n">listDv</span><span class="p">,</span> <span class="n">listVd</span><span class="p">,</span> <span class="n">nameDVH</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="p">)</span>

             
            <span class="c">#Plot and export motion history</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span> 
                <span class="n">historyMotion</span> <span class="o">=</span> <span class="n">motion</span><span class="o">.</span><span class="n">getHistory</span><span class="p">()</span>
                <span class="n">listX</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">historyMotion</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">historyMotion</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">historyMotion</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">])]</span>
                <span class="n">listY</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">historyMotion</span><span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">historyMotion</span><span class="p">[</span><span class="s">&#39;y&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">historyMotion</span><span class="p">[</span><span class="s">&#39;z&#39;</span><span class="p">])]</span>
                <span class="n">listNames</span> <span class="o">=</span> <span class="p">[]</span>
    
                <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;X&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">,</span><span class="s">&#39;Z&#39;</span><span class="p">]:</span>
                    <span class="n">nameCurve</span> <span class="o">=</span> <span class="s">&quot;Motion along </span><span class="si">%s</span><span class="s"> axis&quot;</span><span class="o">%</span><span class="n">axis</span>
                    <span class="n">listNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nameCurve</span><span class="p">)</span>
                <span class="n">namePlot</span> <span class="o">=</span> <span class="s">&quot;Motions along X Y Z axis vs time&quot;</span>
                <span class="n">xLabel</span> <span class="o">=</span> <span class="s">&quot;Time (s)&quot;</span>
                <span class="n">yLabel</span> <span class="o">=</span> <span class="s">&quot;Displacement (cm)&quot;</span>
                <span class="p">(</span><span class="n">figure</span><span class="p">,</span><span class="n">subplot</span><span class="p">)</span> <span class="o">=</span> <span class="n">pltData</span><span class="o">.</span><span class="n">drawData</span><span class="p">(</span><span class="n">listX</span><span class="p">,</span><span class="n">listY</span><span class="p">,</span><span class="n">listNames</span> <span class="o">=</span> <span class="n">listNames</span><span class="p">,</span> <span class="n">display</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span><span class="n">namePlot</span><span class="p">,</span> <span class="n">xLabel</span> <span class="o">=</span> <span class="n">xLabel</span><span class="p">,</span> <span class="n">yLabel</span> <span class="o">=</span>  <span class="n">yLabel</span><span class="p">,</span><span class="n">posLegend</span> <span class="o">=</span><span class="bp">None</span> <span class="p">)</span>
                <span class="n">pathToSave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">mainPath</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">nameSimulation</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span>
                <span class="n">pltData</span><span class="o">.</span><span class="n">savePlotImage</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">namePlot</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="s">&quot;_&quot;</span><span class="p">)</span> <span class="p">,</span> <span class="n">dirPath</span> <span class="o">=</span> <span class="n">pathToSave</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="s">&#39;png&#39;</span><span class="p">,</span> <span class="n">subplot</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span>
                <span class="n">pltData</span><span class="o">.</span><span class="n">closePlot</span><span class="p">()</span>
                <span class="n">listData</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">historyMotion</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">historyMotion</span><span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">historyMotion</span><span class="p">[</span><span class="s">&#39;y&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">historyMotion</span><span class="p">[</span><span class="s">&#39;z&#39;</span><span class="p">])</span> <span class="p">]</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;time(s)&#39;</span><span class="p">,</span><span class="s">&#39;X(cm)&#39;</span><span class="p">,</span><span class="s">&#39;Y(cm)&#39;</span><span class="p">,</span><span class="s">&#39;Z(cm)&#39;</span><span class="p">]</span>
                <span class="n">exportListDataToCSV</span><span class="p">(</span><span class="n">listData</span><span class="p">,</span><span class="n">names</span><span class="p">,</span><span class="n">pathToSave</span><span class="p">,</span><span class="n">namePlot</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="s">&quot;_&quot;</span><span class="p">))</span>
                <span class="k">print</span> <span class="s">&quot;Motion history exported&quot;</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">compensationDynamic</span><span class="p">:</span>
                    <span class="n">newRTPlanPath</span> <span class="o">=</span> <span class="n">pathToSave</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">nameNewRPFile</span>
                    <span class="k">if</span> <span class="n">compensatedPlan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">tool</span><span class="o">.</span><span class="n">saveCompensatedRTPlan</span><span class="p">(</span><span class="n">dicomDataPlanPath</span><span class="p">,</span> <span class="n">newRTPlanPath</span><span class="p">,</span> <span class="n">compensatedPlan</span><span class="p">)</span>
                    <span class="n">historyMonitoring</span> <span class="o">=</span>  <span class="n">monitoringSystm</span><span class="o">.</span><span class="n">getHistory</span><span class="p">()</span>
                    <span class="n">listX</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">historyMonitoring</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">historyMonitoring</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">historyMonitoring</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">])]</span>
                    <span class="n">listYMeasure</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">historyMonitoring</span><span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">][</span><span class="s">&#39;MeasuredMotion&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">historyMonitoring</span><span class="p">[</span><span class="s">&#39;y&#39;</span><span class="p">][</span><span class="s">&#39;MeasuredMotion&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">historyMonitoring</span><span class="p">[</span><span class="s">&#39;z&#39;</span><span class="p">][</span><span class="s">&#39;MeasuredMotion&#39;</span><span class="p">])]</span>
                    <span class="n">listYMotion</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">historyMonitoring</span><span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">][</span><span class="s">&#39;PatientMotion&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">historyMonitoring</span><span class="p">[</span><span class="s">&#39;y&#39;</span><span class="p">][</span><span class="s">&#39;PatientMotion&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">historyMonitoring</span><span class="p">[</span><span class="s">&#39;z&#39;</span><span class="p">][</span><span class="s">&#39;PatientMotion&#39;</span><span class="p">])]</span>
                    <span class="n">listData</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">historyMonitoring</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">])]</span>
                    <span class="n">listData</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">listYMeasure</span><span class="p">)</span>
                    <span class="n">listData</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">listYMotion</span><span class="p">)</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;time(s)&#39;</span><span class="p">,</span><span class="s">&#39;X_Measure(cm)&#39;</span><span class="p">,</span><span class="s">&#39;Y_Measure(cm)&#39;</span><span class="p">,</span><span class="s">&#39;Z_Measure(cm)&#39;</span><span class="p">]</span>
                    <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;X_Motion(cm)&#39;</span><span class="p">,</span><span class="s">&#39;Y_Motion(cm)&#39;</span><span class="p">,</span><span class="s">&#39;Z_Motion(cm)&#39;</span><span class="p">])</span>
                    <span class="n">exportListDataToCSV</span><span class="p">(</span><span class="n">listData</span><span class="p">,</span><span class="n">names</span><span class="p">,</span><span class="n">pathToSave</span><span class="p">,</span><span class="s">&quot;TimeVsMeasureVsMotion&quot;</span><span class="p">)</span>
                    
            <span class="k">return</span>

<span class="c">################################################</span>
<span class="c">#########         Utility functions</span>
<span class="c">################################################</span>


            
<div class="viewcode-block" id="MSPT.save2DSliceToCSV"><a class="viewcode-back" href="../../../mspt.simulator.html#mspt.simulator.simulatorMSPT.MSPT.save2DSliceToCSV">[docs]</a>    <span class="k">def</span> <span class="nf">save2DSliceToCSV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Save a 2D numpy array to CSV file. </span>
<span class="sd">        </span>
<span class="sd">        :param data: 2D numpy array</span>
<span class="sd">        :param filename: Name of the output file.</span>
<span class="sd">        </span>
<span class="sd">        If the number of columns is greater than 255 and and the number of rows is smaller than 255, we trasnpose the rows and columns\</span>
<span class="sd">        in order to be able to open the file in Excel or Numbers. If both dimensions are greater than 255, we remove the same number of columns on the left \</span>
<span class="sd">        and on the right, such that the remaining number of columns is 255.</span>
<span class="sd">        </span>
<span class="sd">        The csv file is stored in the CSV_Data/ folder of the simulation directory.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="n">test</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">typetest</span><span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="n">typetest</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;type data: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;In save2DSliceToCSV, data is not *NumPy* array&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="k">print</span> <span class="s">&quot;shape data: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;In save2DSliceToCSV, data is not NumPy *2D array*&#39;</span><span class="p">)</span>
        
        <span class="n">pathToSave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">mainPath</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">nameSimulation</span> <span class="o">+</span> <span class="s">&quot;CSV_Data/&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">)</span>     
            
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>    
            <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;.csv&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&quot;.csv&quot;</span>
        <span class="k">else</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&quot;.csv&quot;</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">255</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">:</span>
            <span class="n">newData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">255</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">:</span>
            <span class="n">newData</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">255</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">255</span><span class="p">:</span>
            <span class="n">nbColsToRemove</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">255</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nbColsToRemove</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nbLeft</span> <span class="o">=</span> <span class="n">nbColsToRemove</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">nbRight</span> <span class="o">=</span> <span class="n">nbLeft</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nbLeft</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbColsToRemove</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">nbRight</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbColsToRemove</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">newData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">255</span><span class="p">))</span>
            <span class="n">newData</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="n">nbLeft</span><span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">nbRight</span> <span class="p">]</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">255</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="p">:</span>
            <span class="n">newData</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Shape data csv, unexpected, : </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span> <span class="n">pathToSave</span><span class="o">+</span><span class="n">filename</span><span class="p">,</span><span class="n">newData</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="MSPT.save2DListToCSV"><a class="viewcode-back" href="../../../mspt.simulator.html#mspt.simulator.simulatorMSPT.MSPT.save2DListToCSV">[docs]</a>    <span class="k">def</span> <span class="nf">save2DListToCSV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Save a 2D list into a CSV file.</span>

<span class="sd">        :param data: 2D list</span>
<span class="sd">        :param filename: Name of the output file.</span>

<span class="sd">         The csv file is stored in the CSV_Data/ folder of the simulation directory.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">pathToSave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">mainPath</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">nameSimulation</span> <span class="o">+</span> <span class="s">&quot;CSV_Data/&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">)</span>             
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>    
            <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;.csv&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&quot;.csv&quot;</span>
        <span class="k">else</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&quot;.csv&quot;</span>
        <span class="n">myFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pathToSave</span><span class="o">+</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">wr</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">myFile</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_ALL</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">wr</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">myFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        


</div></div>
<div class="viewcode-block" id="exportListDataToCSV"><a class="viewcode-back" href="../../../mspt.simulator.html#mspt.simulator.simulatorMSPT.exportListDataToCSV">[docs]</a><span class="k">def</span> <span class="nf">exportListDataToCSV</span><span class="p">(</span><span class="n">listsValues</span><span class="p">,</span><span class="n">names</span><span class="p">,</span><span class="n">pathToSave</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Export a list to a CSV file.</span>
<span class="sd">    </span>
<span class="sd">    :param listsValues: List of values to store.</span>
<span class="sd">    :param names: List of headers.</span>
<span class="sd">    :param pathToSave: Path where to save the CSV file.</span>
<span class="sd">    :param filename: Name of the output file. </span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
   
    <span class="n">dataToExport</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
   
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">listsValues</span><span class="p">):</span>
        <span class="n">listVal</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">listVal</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">names</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="n">dataToExport</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">listVal</span><span class="p">)</span>

    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.csv&quot;</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&quot;.csv&quot;</span>
        
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">pathToSave</span> <span class="o">+</span><span class="n">filename</span> <span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">dataToExport</span><span class="p">),</span><span class="n">fmt</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;,&#39;</span><span class="p">,</span><span class="n">newline</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&quot;Data exported: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">pathToSave</span> <span class="o">+</span><span class="n">filename</span><span class="p">)</span>

</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;Simulator PID: </span><span class="si">%s</span><span class="s"> on </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span> <span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">configFile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.py&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.txt&quot;</span><span class="p">):</span>
                <span class="n">configFile</span> <span class="o">=</span> <span class="n">item</span>
                <span class="n">globalVar</span> <span class="o">=</span> <span class="n">GlobalVariables</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">item</span> <span class="o">==</span> <span class="s">&#39;--motion&#39;</span><span class="p">:</span>
                <span class="k">print</span> <span class="n">item</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;tmp_ConfigData.txt&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">myFile</span><span class="p">:</span>
                    <span class="n">myFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;staticDelivery = False </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
<span class="c">#                     myFile.write(&quot;arrayAmpl =  [0.0,  0,  0.0] \n&quot;)</span>
                <span class="n">configFile</span> <span class="o">=</span> <span class="s">&#39;tmp_ConfigData.txt&#39;</span>
                <span class="n">globalVar</span> <span class="o">=</span> <span class="n">GlobalVariables</span><span class="p">(</span><span class="n">configFile</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> tmp_ConfigData.txt&quot;</span><span class="o">%</span><span class="n">rmCmd</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">configFile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">globalVar</span> <span class="o">=</span> <span class="n">GlobalVariables</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        
        <span class="n">pathToTest</span> <span class="o">=</span> <span class="n">globalVar</span><span class="o">.</span><span class="n">mainPath</span> <span class="o">+</span> <span class="n">globalVar</span><span class="o">.</span><span class="n">nameSimulation</span>
        <span class="k">print</span> <span class="n">pathToTest</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pathToTest</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">pathToTest</span><span class="p">)</span>
        <span class="n">pathToSave</span> <span class="o">=</span> <span class="n">pathToTest</span> <span class="o">+</span>  <span class="n">globalVar</span><span class="o">.</span><span class="n">nameProfilage</span>

        <span class="k">if</span> <span class="n">globalVar</span><span class="o">.</span><span class="n">stdOutErrToFile</span><span class="p">:</span>
            <span class="n">bkpStdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
            <span class="n">bkpStderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>    
            <span class="n">fStdout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pathToTest</span> <span class="o">+</span> <span class="s">&quot;stdout.txt&quot;</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">fStdErr</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pathToTest</span> <span class="o">+</span> <span class="s">&quot;stderr.txt&quot;</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">fStdout</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">fStdErr</span>
        <span class="k">print</span> <span class="s">&quot;Simulator PID: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="n">simulStartDate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;Simulation began on </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">simulStartDate</span><span class="o">.</span><span class="n">ctime</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cProfile</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s">&#39;MSPT(sys.argv[1:], globalVar)&#39;</span><span class="p">,</span><span class="n">pathToSave</span><span class="p">)</span>
            
            <span class="n">simulEndDate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">timeSimul</span> <span class="o">=</span> <span class="n">simulEndDate</span> <span class="o">-</span> <span class="n">simulStartDate</span>
            <span class="k">print</span> <span class="s">&quot;Simulation ended on </span><span class="si">%s</span><span class="s"> in </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">simulEndDate</span><span class="o">.</span><span class="n">ctime</span><span class="p">(),</span><span class="nb">str</span><span class="p">(</span><span class="n">timeSimul</span><span class="p">))</span>
            
            <span class="c">#Copy config file</span>
<span class="c">#             if configFile is not None:</span>
<span class="c">#                 os.system(&quot;%s %s %s&quot;%(cpCmd,configFile, pathToTest))</span>
<span class="c">#             else:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pathToTest</span> <span class="o">+</span> <span class="s">&#39;MSPT_</span><span class="si">%s</span><span class="s">_ConfigData.txt&#39;</span><span class="o">%</span><span class="n">globalVar</span><span class="o">.</span><span class="n">nameSimulation</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">myFile</span><span class="p">:</span>
                <span class="n">myFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;#############################</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">myFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;## Configuration file for simulation </span><span class="si">%s</span><span class="s"> </span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">globalVar</span><span class="o">.</span><span class="n">nameSimulation</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">myFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;#############################</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">globalVar</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s">&#39;motionInfo&#39;</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s">&#39;settingsScanning&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">globalVar</span><span class="o">.</span><span class="n">authorizedKeys</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">globalVar</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="nb">str</span><span class="p">):</span>
                                <span class="n">myFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s"> </span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">globalVar</span><span class="p">[</span><span class="n">key</span><span class="p">])))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">myFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> = &#39;</span><span class="si">%s</span><span class="s">&#39; </span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">globalVar</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
                    <span class="k">else</span> <span class="p">:</span>
                        <span class="k">for</span> <span class="n">subkey</span> <span class="ow">in</span>  <span class="nb">sorted</span><span class="p">(</span><span class="n">globalVar</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">globalVar</span><span class="o">.</span><span class="n">authorizedKeys</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">globalVar</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">subkey</span><span class="p">],</span><span class="nb">str</span><span class="p">):</span>
                                    <span class="n">myFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s"> </span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">globalVar</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">subkey</span><span class="p">])))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">myFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> = &#39;</span><span class="si">%s</span><span class="s">&#39; </span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span><span class="n">globalVar</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">subkey</span><span class="p">]))</span>

            
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">globalVar</span><span class="o">.</span><span class="n">mainPath</span><span class="o">+</span><span class="s">&quot;output&quot;</span><span class="o">+</span><span class="n">globalVar</span><span class="o">.</span><span class="n">nameSimulation</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cpCmd</span><span class="p">,</span><span class="n">globalVar</span><span class="o">.</span><span class="n">mainPath</span><span class="o">+</span><span class="s">&quot;output&quot;</span><span class="o">+</span><span class="n">globalVar</span><span class="o">.</span><span class="n">nameSimulation</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">globalVar</span><span class="o">.</span><span class="n">mainPath</span><span class="o">+</span><span class="s">&quot;output&quot;</span><span class="o">+</span><span class="n">globalVar</span><span class="o">.</span><span class="n">nameSimulation</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;.txt&quot;</span><span class="p">))</span>
            
            <span class="n">textEmail</span> <span class="o">=</span> <span class="s">&quot;&lt;p&gt;Simulation </span><span class="si">%s</span><span class="s"> started on </span><span class="si">%s</span><span class="s"> (server: </span><span class="si">%s</span><span class="s">), ended properly on </span><span class="si">%s</span><span class="s"> in </span><span class="si">%s</span><span class="s">.&lt;/p&gt;&lt;p&gt;Good job!&lt;/p&gt;&quot;</span><span class="o">%</span><span class="p">(</span> <span class="n">Email</span><span class="o">.</span><span class="n">htmlTextBoldRed</span><span class="p">(</span><span class="n">globalVar</span><span class="o">.</span><span class="n">nameSimulation</span><span class="p">),</span><span class="n">Email</span><span class="o">.</span><span class="n">htmlTextBoldRed</span><span class="p">(</span><span class="n">simulStartDate</span><span class="o">.</span><span class="n">ctime</span><span class="p">()),</span><span class="n">Email</span><span class="o">.</span><span class="n">htmlTextBoldRed</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())),</span><span class="n">simulEndDate</span><span class="o">.</span><span class="n">ctime</span><span class="p">(),</span><span class="nb">str</span><span class="p">(</span><span class="n">timeSimul</span><span class="p">))</span>
            <span class="n">attachment</span> <span class="o">=</span> <span class="p">[</span><span class="n">globalVar</span><span class="o">.</span><span class="n">mainPath</span> <span class="o">+</span> <span class="n">globalVar</span><span class="o">.</span><span class="n">nameSimulation</span> <span class="o">+</span> <span class="s">&quot;DVH_Data/&quot;</span><span class="o">+</span><span class="s">&quot;DVH_SimulatedDose.png&quot;</span><span class="p">,</span>\
            <span class="n">globalVar</span><span class="o">.</span><span class="n">mainPath</span> <span class="o">+</span> <span class="n">globalVar</span><span class="o">.</span><span class="n">nameSimulation</span> <span class="o">+</span> <span class="s">&quot;DVH_Data/&quot;</span><span class="o">+</span><span class="s">&quot;DVH_ReferenceDose.png&quot;</span><span class="p">]</span>
            <span class="n">dataToZip</span> <span class="o">=</span> <span class="p">[</span><span class="n">globalVar</span><span class="o">.</span><span class="n">mainPath</span> <span class="o">+</span> <span class="n">globalVar</span><span class="o">.</span><span class="n">nameSimulation</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">globalVar</span><span class="o">.</span><span class="n">mainPath</span><span class="o">+</span><span class="s">&quot;output&quot;</span><span class="o">+</span><span class="n">globalVar</span><span class="o">.</span><span class="n">nameSimulation</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;.txt&quot;</span><span class="p">):</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="c"># Allow to finish writting in the file</span>
                <span class="n">attachment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">globalVar</span><span class="o">.</span><span class="n">mainPath</span><span class="o">+</span><span class="s">&quot;output&quot;</span><span class="o">+</span><span class="n">globalVar</span><span class="o">.</span><span class="n">nameSimulation</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;.txt&quot;</span><span class="p">)</span>
                <span class="n">dataToZip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">globalVar</span><span class="o">.</span><span class="n">mainPath</span><span class="o">+</span><span class="s">&quot;output&quot;</span><span class="o">+</span><span class="n">globalVar</span><span class="o">.</span><span class="n">nameSimulation</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;.txt&quot;</span><span class="p">)</span>
            <span class="n">zipname</span> <span class="o">=</span> <span class="n">globalVar</span><span class="o">.</span><span class="n">mainPath</span> <span class="o">+</span> <span class="n">globalVar</span><span class="o">.</span><span class="n">nameSimulation</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;.zip&#39;</span>
            <span class="n">zipFiles</span><span class="o">.</span><span class="n">archiveDataFromListPath</span><span class="p">(</span><span class="n">dataToZip</span> <span class="p">,</span> <span class="n">zipname</span><span class="p">,</span> <span class="n">goToSubDir</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">,</span><span class="n">listExt</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">rmCommonPath</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">globalVar</span><span class="o">.</span><span class="n">copyZip</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">globalVar</span><span class="o">.</span><span class="n">pathToSendZip</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">globalVar</span><span class="o">.</span><span class="n">pathToSendZip</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">scpCmd</span><span class="p">,</span><span class="n">zipname</span><span class="p">,</span> <span class="n">globalVar</span><span class="o">.</span><span class="n">pathToSendZip</span><span class="p">))</span>
                <span class="n">textEmail</span> <span class="o">=</span> <span class="n">textEmail</span> <span class="o">+</span> <span class="s">&quot;&lt;p&gt;Zipfile </span><span class="si">%s</span><span class="s"> sent to </span><span class="si">%s</span><span class="s">.&lt;/p&gt;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">zipname</span><span class="p">,</span> <span class="n">globalVar</span><span class="o">.</span><span class="n">pathToSendZip</span><span class="p">)</span>
            <span class="n">emailSent</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">myEmail</span> <span class="o">=</span> <span class="n">emailManager</span><span class="p">(</span> <span class="n">globalVar</span><span class="o">.</span><span class="n">emailUser</span><span class="p">,</span><span class="n">globalVar</span><span class="o">.</span><span class="n">emailPwd</span><span class="p">,</span><span class="n">globalVar</span><span class="o">.</span><span class="n">emailSMTP</span><span class="p">,</span><span class="n">globalVar</span><span class="o">.</span><span class="n">emailSMTPPort</span><span class="p">)</span>
                <span class="n">myEmail</span><span class="o">.</span><span class="n">mail</span><span class="p">(</span><span class="n">globalVar</span><span class="o">.</span><span class="n">emailRecipient</span><span class="p">,</span><span class="s">&quot;Simulation done&quot;</span><span class="p">,</span><span class="n">textEmail</span><span class="p">,</span><span class="n">attach</span><span class="o">=</span><span class="n">attachment</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">attachment</span> <span class="o">=</span> <span class="p">[</span><span class="n">globalVar</span><span class="o">.</span><span class="n">mainPath</span> <span class="o">+</span> <span class="n">globalVar</span><span class="o">.</span><span class="n">nameSimulation</span> <span class="o">+</span> <span class="s">&quot;DVH_Data/&quot;</span><span class="o">+</span><span class="s">&quot;DVH_SimulatedDose.png&quot;</span><span class="p">,</span>\
            <span class="n">globalVar</span><span class="o">.</span><span class="n">mainPath</span> <span class="o">+</span> <span class="n">globalVar</span><span class="o">.</span><span class="n">nameSimulation</span> <span class="o">+</span> <span class="s">&quot;DVH_Data/&quot;</span><span class="o">+</span><span class="s">&quot;DVH_ReferenceDose.png&quot;</span><span class="p">]</span>
                <span class="n">textEmail</span> <span class="o">=</span> <span class="n">textEmail</span> <span class="o">+</span> <span class="s">&quot;&lt;p&gt;Only DVHs attached.&lt;/p&gt;&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">myEmail</span> <span class="o">=</span> <span class="n">emailManager</span><span class="p">(</span> <span class="n">globalVar</span><span class="o">.</span><span class="n">emailUser</span><span class="p">,</span><span class="n">globalVar</span><span class="o">.</span><span class="n">emailPwd</span><span class="p">,</span><span class="n">globalVar</span><span class="o">.</span><span class="n">emailSMTP</span><span class="p">,</span><span class="n">globalVar</span><span class="o">.</span><span class="n">emailSMTPPort</span><span class="p">)</span>
                    <span class="n">myEmail</span><span class="o">.</span><span class="n">mail</span><span class="p">(</span><span class="n">globalVar</span><span class="o">.</span><span class="n">emailRecipient</span><span class="p">,</span><span class="s">&quot;Simulation done&quot;</span><span class="p">,</span><span class="n">textEmail</span><span class="p">,</span><span class="n">attach</span><span class="o">=</span><span class="n">attachment</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;Sorry ... something went wrong. The final email has not been sent. Check emailUser, emailPwd, emailSMTP,emailSMTPPort or emailRecipient in the configuration file&quot;</span>
                    <span class="n">emailSent</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">emailSent</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Email sent to </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">globalVar</span><span class="o">.</span><span class="n">emailRecipient</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">globalVar</span><span class="o">.</span><span class="n">mainPath</span><span class="o">+</span><span class="s">&quot;output&quot;</span><span class="o">+</span><span class="n">globalVar</span><span class="o">.</span><span class="n">nameSimulation</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;.txt&quot;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">globalVar</span><span class="o">.</span><span class="n">mainPath</span><span class="o">+</span><span class="s">&quot;output&quot;</span><span class="o">+</span><span class="n">globalVar</span><span class="o">.</span><span class="n">nameSimulation</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;.txt&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">simulEndDate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&quot;Simulation ended on </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">simulEndDate</span><span class="o">.</span><span class="n">ctime</span><span class="p">()</span>
            <span class="n">textEmail</span> <span class="o">=</span> <span class="s">&quot;&lt;p&gt;The simulation </span><span class="si">%s</span><span class="s"> (PID: </span><span class="si">%s</span><span class="s"> - server: </span><span class="si">%s</span><span class="s">) started on </span><span class="si">%s</span><span class="s"> crashed...&lt;/p&gt;&lt;p&gt;An unexpected error happened on </span><span class="si">%s</span><span class="s"> : &lt;/p&gt;&lt;p&gt;----------------&lt;/p&gt;&lt;p&gt;</span><span class="si">%s</span><span class="s">  &lt;/p&gt;&lt;p&gt;----------------&lt;/p&gt;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">Email</span><span class="o">.</span><span class="n">htmlTextBoldRed</span><span class="p">(</span><span class="n">globalVar</span><span class="o">.</span><span class="n">nameSimulation</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()),</span><span class="n">Email</span><span class="o">.</span><span class="n">htmlTextBoldRed</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())),</span><span class="n">Email</span><span class="o">.</span><span class="n">htmlTextBoldRed</span><span class="p">(</span><span class="n">simulStartDate</span><span class="o">.</span><span class="n">ctime</span><span class="p">()),</span><span class="n">simulEndDate</span><span class="o">.</span><span class="n">ctime</span><span class="p">(),</span><span class="n">Email</span><span class="o">.</span><span class="n">htmlTextBoldRed</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&gt;&#39;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)))</span>
            <span class="n">strInfo</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">newStrInfo</span> <span class="o">=</span><span class="s">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">strInfo</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span>
                <span class="n">newStrInfo</span> <span class="o">=</span><span class="n">newStrInfo</span> <span class="o">+</span><span class="s">&#39;&lt;br&gt;&#39;</span><span class="o">+</span><span class="n">line</span><span class="o">+</span><span class="s">&#39;&lt;/br&gt;&#39;</span>
            <span class="n">textEmail</span> <span class="o">=</span> <span class="n">textEmail</span> <span class="o">+</span><span class="s">&quot;&lt;p&gt;&quot;</span><span class="o">+</span> <span class="n">newStrInfo</span> <span class="o">+</span> <span class="s">&quot;&lt;/p&gt;&lt;p&gt;----------------&lt;/p&gt;&lt;p&gt;Try again...!&lt;/p&gt;&quot;</span>
            <span class="k">print</span> <span class="s">&quot;Unexpected error:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">myEmail</span> <span class="o">=</span> <span class="n">emailManager</span><span class="p">(</span> <span class="n">globalVar</span><span class="o">.</span><span class="n">emailUser</span><span class="p">,</span><span class="n">globalVar</span><span class="o">.</span><span class="n">emailPwd</span><span class="p">,</span><span class="n">globalVar</span><span class="o">.</span><span class="n">emailSMTP</span><span class="p">,</span><span class="n">globalVar</span><span class="o">.</span><span class="n">emailSMTPPort</span><span class="p">)</span>
                <span class="n">myEmail</span><span class="o">.</span><span class="n">mail</span><span class="p">(</span><span class="n">globalVar</span><span class="o">.</span><span class="n">emailRecipient</span><span class="p">,</span><span class="s">&quot;Simulation crashed&quot;</span><span class="p">,</span><span class="n">textEmail</span><span class="p">,</span><span class="n">attach</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&quot;Crash report sent to </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">globalVar</span><span class="o">.</span><span class="n">emailRecipient</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Sorry ... something went wrong. The crash report email has not been sent. Check emailUser, emailPwd, emailSMTP,emailSMTPPort or emailRecipient in the configuration file&quot;</span>
            <span class="k">raise</span>
        
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">globalVar</span><span class="o">.</span><span class="n">removeProfilageData</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">globalVar</span><span class="o">.</span><span class="n">stdOutErrToFile</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">bkpStdout</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">bkpStderr</span>  
            
                <span class="n">fStdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">fStdErr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;MSPT terminated because it doesn&#39;t have the right number of input parameters. Expected: 3 (CT,RP,RS), 4 (CT,RP,RS,RD/config/--motion) or 5(CT,RP,RS,RD,config/--motion), given: </span><span class="si">%i</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Paul Morel, LIGM, Univ. Paris-Est MLV, France.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>